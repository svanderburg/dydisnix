{ pkgs
, dydisnix ? builtins.storePath @prefix@
, disnix ? builtins.storePath @DISNIX_PREFIX@
}:

let
  inherit (builtins) toXML;
in
rec {
  generateServicesXML = services:
    let servicesXSL = ./services.xsl;
    in
    pkgs.stdenv.mkDerivation {
      name = "services.xml";
      buildInputs = [ pkgs.libxslt ];
      buildCommand = ''
      (
      cat << "EOF"
      ${builtins.toXML services}
      EOF
      ) | xsltproc ${servicesXSL} - > $out
      '';
    }
  ;
  
  generateInfrastructureXML = infrastructure:
    let infrastructureXSL = "${disnix}/share/disnix/infrastructure.xsl";
    in
    pkgs.stdenv.mkDerivation {
      name = "infrastructure.xml";
      buildInputs = [ pkgs.libxslt dydisnix ];
      buildCommand = ''
      (
      cat << "EOF"
      ${builtins.toXML infrastructure}
      EOF
      ) | xsltproc ${infrastructureXSL} - > $out
      '';
    }
  ;
  
  generateDistributionXML = distribution:
    let distributionXSL = ./distribution.xsl;
    in
    pkgs.stdenv.mkDerivation {
      name = "distribution.xml";
      buildInputs = [ pkgs.libxslt ];
      buildCommand = ''
      (
      cat << "EOF"
      ${builtins.toXML distribution}
      EOF
      ) | xsltproc ${distributionXSL} - > $out
      '';
    }
  ;

  generatePreviousDistribution = coordinatorProfile:
    let generateMappingXSL = ./generate-mapping.xsl;
    in
    import "${(pkgs.stdenv.mkDerivation {
      name = "distribution.nix";
      buildInputs = [ pkgs.libxslt ];
      buildCommand = ''
        xsltproc ${generateMappingXSL} ${coordinatorProfile} > $out
      '';
    })}"
  ;

  divide = {strategy, services, infrastructure, distribution, serviceProperty, targetProperty}:
    import "${(pkgs.stdenv.mkDerivation {
      name = "distribution.nix";
      buildInputs = [ dydisnix ];
      buildCommand = 
      ''
        dydisnix-divide \
          --strategy ${strategy} \
          --services-xml ${generateServicesXML services} \
          --infrastructure-xml ${generateInfrastructureXML infrastructure} \
          --distribution-xml ${generateDistributionXML distribution} \
          --service-property ${serviceProperty} \
          --target-property ${targetProperty} \
          > $out
      '';
    })}";

  multiwaycut = {distribution}:
    import "${(pkgs.stdenv.mkDerivation {
      name = "distribution.nix";
      buildInputs = [ dydisnix ];
      buildCommand =
      ''
        dydisnix-multiwaycut ${generateDistributionXML distribution} > $out
      '';
    })}";

  minsetcover = {services, infrastructure, distribution, targetProperty}:
    import "${(pkgs.stdenv.mkDerivation {
      name = "distribution.nix";
      buildInputs = [ dydisnix ];
      buildCommand =
      ''
        dydisnix-minsetcover \
          --services-xml ${generateServicesXML services} \
          --infrastructure-xml ${generateInfrastructureXML infrastructure} \
          --distribution-xml ${generateDistributionXML distribution} \
          --target-property ${targetProperty} \
          > $out
      '';
    })}";

  graphcol = {services, infrastructure}:
    import "${(pkgs.stdenv.mkDerivation {
      name = "distribution.nix";
      buildInputs = [ dydisnix ];
      buildCommand =
      ''
         dydisnix-graphcol \
          --services-xml ${generateServicesXML services} \
          --infrastructure-xml ${generateInfrastructureXML infrastructure} \
          > $out
      '';
    })}";
}
