{servicesFile, infrastructureFile, distributionFile, serviceName, targetName}:

let
  inherit (builtins) getAttr;

  servicesFun = import servicesFile;
  infrastructure = import infrastructureFile;
  distributionFun = import distributionFile;
  
  lib = import @DISNIX_PREFIX@/share/disnix/lib.nix;
  
  services = servicesFun { system = builtins.currentSystem; distribution = null; pkgs = null; };
  distribution = distributionFun { inherit infrastructure; };
  
  servicesWithTargets = lib.augumentTargetsInDependsOn distribution services;
  target = getAttr targetName infrastructure;
  system = if target ? system then target.system else builtins.currentSystem;
  pkgs = lib.selectPkgs system;
  service = getAttr serviceName (servicesFun { inherit distribution system pkgs; });
in
if service ? dependsOn && service.dependsOn != {} then service.pkg (service.dependsOn) else service.pkg
