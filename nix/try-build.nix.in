{ servicesFile, infrastructureFile, distributionFile, serviceName, targetName, defaultClientInterface, defaultTargetProperty
, nixpkgs ? <nixpkgs>
, disnix ? builtins.storePath @DISNIX_PREFIX@
}:

let
  inherit (builtins) getAttr;

  servicesFun = import servicesFile;
  infrastructure = import infrastructureFile;
  distributionFun = import distributionFile;

  pkgs = import nixpkgs {};

  wrapArchitecture = import "${disnix}/share/disnix/wrap-architecture.nix" {
    inherit (pkgs) lib;
  };

  normalizeArchitecture = import "${disnix}/share/disnix/normalize-architecture.nix" {
    inherit (pkgs) lib;
  };

  architectureFun = wrapArchitecture {
    inherit servicesFun infrastructure distributionFun;
    packagesFun = null;
  };

  normalizedArchitecture = normalizeArchitecture {
    inherit architectureFun nixpkgs defaultClientInterface defaultTargetProperty;
    defaultDeployState = false;
  };

  target = getAttr targetName infrastructure;
  system = if target ? system then target.system else builtins.currentSystem;
in
normalizedArchitecture.services."${serviceName}"._pkgsPerSystem."${system}"
